<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PushBot - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–µ–ø–ª–æ–µ–≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#2c3e50',
                        'primary-light': '#3498db',
                        'success': '#27ae60',
                        'danger': '#e74c3c',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans leading-relaxed">
    {% raw %}
    <div id="app" class="relative">
        <header class="bg-primary text-white py-5 mb-8 shadow-md">
            <div class="container mx-auto max-w-7xl px-5">
                <h1 class="text-center text-3xl font-bold">üöÄ PushBot - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–µ–ø–ª–æ–µ–≤</h1>
            </div>
        </header>

        <div class="container mx-auto max-w-7xl px-5">
            <!-- –î–µ–ø–ª–æ–∏ -->
            <div class="bg-white rounded-lg p-5 mb-5 shadow-md">
                <h2 class="text-xl font-semibold text-primary mb-4 pb-2 border-b-2 border-primary-light">
                    –î–µ–ø–ª–æ–∏
                </h2>
                <button 
                    class="bg-primary-light hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white px-5 py-2 rounded text-sm mb-4 transition-colors duration-300"
                    @click="refreshDeployments"
                    :disabled="loading.deployments"
                >
                    {{ loading.deployments ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–û–±–Ω–æ–≤–∏—Ç—å' }}
                </button>
                <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–≤—Ä–µ–º–µ–Ω–Ω–æ) -->
                <div v-if="false" class="text-xs text-gray-400 mb-2 p-2 bg-gray-100 rounded">
                    Debug: active={{ activeDeployments.length }}, recent={{ recentDeployments.length }}, all={{ allDeployments.length }}, loading={{ loading.deployments }}
                </div>
                <div v-if="allDeployments.length === 0 && !loading.deployments" class="text-center py-10 text-gray-500">
                    –ù–µ—Ç –¥–µ–ø–ª–æ–µ–≤
                </div>
                <div v-else-if="loading.deployments" class="text-center py-10 text-gray-500">
                    –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
                <div v-else class="space-y-2">
                    <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –¥–µ–ø–ª–æ–∏ (—Å–≤–µ—Ä—Ö—É, —Å –∂—ë–ª—Ç–æ–π —Ä–∞–º–∫–æ–π) -->
                    <template v-if="activeDeployments.length > 0">
                        <deployment-history-item
                            v-for="deployment in activeDeployments"
                            :key="'active-' + deployment.id"
                            :deployment="deployment"
                            :services="services"
                            :is-active="true"
                            @show-logs="showLogsDrawer"
                            @update-status="updateDeploymentStatus"
                        />
                    </template>
                    <!-- –ò—Å—Ç–æ—Ä–∏—è –¥–µ–ø–ª–æ–µ–≤ -->
                    <template v-if="recentDeployments.length > 0">
                        <deployment-history-item
                            v-for="deployment in recentDeployments"
                            :key="'recent-' + deployment.id"
                            :deployment="deployment"
                            :services="services"
                            :is-active="false"
                            @show-logs="showLogsDrawer"
                        />
                    </template>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ -->
            <div class="bg-white rounded-lg p-5 mb-5 shadow-md">
                <h2 class="text-xl font-semibold text-primary mb-4 pb-2 border-b-2 border-primary-light">
                    –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
                </h2>
                <div v-if="services.length === 0" class="text-center py-10 text-gray-500">
                    –ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
                </div>
                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div v-for="service in services" :key="service.id" class="border border-gray-300 rounded-lg p-4 bg-gray-50">
                        <h3 class="text-lg font-semibold text-primary mb-2">{{ service.name }}</h3>
                        <div class="text-sm text-gray-600 mb-3">
                            <p class="mb-1"><span class="font-bold text-gray-800">–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:</span> {{ service.repository }}</p>
                            <p class="mb-1"><span class="font-bold text-gray-800">–ü—É—Ç—å:</span> {{ service.path }}</p>
                            <p class="mb-1"><span class="font-bold text-gray-800">–í–µ—Ç–∫–∞:</span> {{ service.branch }}</p>
                        </div>
                        <button 
                            @click="deployService(service.id)"
                            :disabled="deployingServices.includes(service.id)"
                            class="w-full bg-primary-light hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white px-4 py-2 rounded text-sm transition-colors duration-300"
                        >
                            {{ deployingServices.includes(service.id) ? '–ó–∞–ø—É—Å–∫...' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–ø–ª–æ–π' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drawer –¥–ª—è –ª–æ–≥–æ–≤ -->
        <div 
            v-if="logsDrawerOpen"
            class="fixed inset-0 z-50 overflow-hidden"
        >
            <!-- Overlay -->
            <div 
                class="absolute inset-0 bg-black bg-opacity-50 transition-opacity"
                @click="closeLogsDrawer"
            ></div>
            
            <!-- Drawer –ø–∞–Ω–µ–ª—å -->
            <div 
                class="absolute right-0 top-0 h-full w-full max-w-3xl bg-white shadow-xl transform transition-transform duration-300 ease-in-out flex flex-col"
                @click.stop
            >
                <!-- Header -->
                <div class="flex items-center justify-between p-4 border-b bg-gray-50">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">
                            {{ getServiceName(logsDrawerDeployment) || '–õ–æ–≥–∏ –¥–µ–ø–ª–æ—è' }}
                        </h3>
                        <p class="text-sm text-gray-500" v-if="logsDrawerDeployment">
                            {{ logsDrawerDeployment.status === 'running' ? '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è' : logsDrawerDeployment.status === 'queued' ? '–í –æ—á–µ—Ä–µ–¥–∏' : logsDrawerDeployment.status === 'success' ? '–£—Å–ø–µ—à–Ω–æ' : logsDrawerDeployment.status === 'failed' ? '–û—à–∏–±–∫–∞' : '–ó–∞–≤–µ—Ä—à–µ–Ω' }}
                            <span v-if="logsDrawerDeployment.commit_sha" class="ml-2 font-mono text-xs">
                                {{ logsDrawerDeployment.commit_sha.substring(0, 7) }}
                            </span>
                        </p>
                    </div>
                    <button 
                        @click="closeLogsDrawer"
                        class="text-gray-500 hover:text-gray-700 p-2 rounded hover:bg-gray-200 transition-colors"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- –õ–æ–≥–∏ -->
                <div class="flex-1 overflow-y-auto bg-gray-900 text-gray-300 p-4 font-mono text-sm logs-drawer-content">
                    <div v-if="logsDrawerLogs.length === 0" class="text-gray-500 text-center py-8">
                        {{ logsDrawerDeployment && (logsDrawerDeployment.status === 'running' || logsDrawerDeployment.status === 'queued') ? '–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...' : '–õ–æ–≥–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç' }}
                    </div>
                    <div 
                        v-for="(log, index) in logsDrawerLogs" 
                        :key="index"
                        :class="['my-1 whitespace-pre-wrap break-words', log.type === 'stderr' ? 'text-red-400' : 'text-gray-300']"
                    >
                        {{ log.line }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}

    {% raw %}
    <script>
        const { createApp } = Vue;

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–µ–ø–ª–æ—è
        const DeploymentCard = {
            props: ['deployment', 'services', 'isActive'],
            data() {
                return {
                    logs: [],
                    eventSource: null,
                    showLogs: false
                };
            },
            computed: {
                serviceName() {
                    const service = this.services.find(s => s.id === this.deployment.service_id);
                    return service ? service.name : 'Unknown';
                },
                statusText() {
                    const statusMap = {
                        'queued': '–í –æ—á–µ—Ä–µ–¥–∏',
                        'running': '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è',
                        'success': '–£—Å–ø–µ—à–Ω–æ',
                        'failed': '–û—à–∏–±–∫–∞'
                    };
                    return statusMap[this.deployment.status] || this.deployment.status;
                },
                statusBadgeClass() {
                    const classes = {
                        'queued': 'bg-yellow-500 text-white',
                        'running': 'bg-primary-light text-white',
                        'success': 'bg-success text-white',
                        'failed': 'bg-danger text-white'
                    };
                    return classes[this.deployment.status] || 'bg-gray-500 text-white';
                },
                borderClass() {
                    const classes = {
                        'queued': 'border-l-4 border-yellow-500',
                        'running': 'border-l-4 border-primary-light',
                        'success': 'border-l-4 border-success',
                        'failed': 'border-l-4 border-danger'
                    };
                    return classes[this.deployment.status] || 'border-l-4 border-gray-400';
                },
                formattedStartTime() {
                    if (!this.deployment.started_at) return '';
                    return new Date(this.deployment.started_at).toLocaleString('ru-RU');
                },
                formattedEndTime() {
                    if (!this.deployment.finished_at) return '';
                    return new Date(this.deployment.finished_at).toLocaleString('ru-RU');
                },
                shortCommitSha() {
                    if (!this.deployment.commit_sha) return '';
                    return this.deployment.commit_sha.substring(0, 7);
                },
                truncatedMessage() {
                    if (!this.deployment.commit_message) return '';
                    return this.deployment.commit_message.length > 100
                        ? this.deployment.commit_message.substring(0, 100) + '...'
                        : this.deployment.commit_message;
                }
            },
            mounted() {
                if (this.isActive) {
                    this.connectToLogs();
                } else if (this.deployment.stdout || this.deployment.stderr) {
                    // –î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –¥–µ–ø–ª–æ–µ–≤ –∑–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
                    if (this.deployment.stdout) {
                        this.deployment.stdout.split('\n').forEach(line => {
                            if (line.trim()) {
                                this.logs.push({ type: 'stdout', line: line });
                            }
                        });
                    }
                    if (this.deployment.stderr) {
                        this.deployment.stderr.split('\n').forEach(line => {
                            if (line.trim()) {
                                this.logs.push({ type: 'stderr', line: line });
                            }
                        });
                    }
                }
            },
            beforeUnmount() {
                if (this.eventSource) {
                    this.eventSource.close();
                }
            },
            methods: {
                connectToLogs() {
                    if (!this.isActive) return;
                    
                    this.eventSource = new EventSource(`/api/deployments/${this.deployment.id}/logs`);
                    
                    this.eventSource.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'status') {
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è
                            this.$emit('update-status', {
                                id: this.deployment.id,
                                status: data.status,
                                exit_code: data.exit_code
                            });
                            this.eventSource.close();
                            return;
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥
                        this.logs.push({
                            type: data.type,
                            line: data.line
                        });
                        
                        // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞
                        this.$nextTick(() => {
                            const container = this.$el.querySelector('.logs-container');
                            if (container) {
                                container.scrollTop = container.scrollHeight;
                            }
                        });
                    };
                    
                    this.eventSource.onerror = (error) => {
                        console.error('–û—à–∏–±–∫–∞ SSE:', error);
                        this.eventSource.close();
                    };
                },
                toggleLogs() {
                    this.showLogs = !this.showLogs;
                }
            },
            template: `
                <div :class="['border border-gray-300 rounded-lg p-4 mb-4 bg-gray-50 transition-all duration-300', borderClass]">
                    <div class="flex justify-between items-center mb-2">
                        <div class="font-bold text-lg">{{ serviceName }}</div>
                        <span :class="['px-3 py-1 rounded-full text-xs font-bold uppercase', statusBadgeClass]">
                            {{ statusText }}
                        </span>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 mb-2 text-sm text-gray-600">
                        <div v-if="formattedStartTime">
                            <span class="font-bold text-gray-800">–ù–∞—á–∞–ª–æ:</span> {{ formattedStartTime }}
                        </div>
                        <div v-if="formattedEndTime">
                            <span class="font-bold text-gray-800">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:</span> {{ formattedEndTime }}
                        </div>
                        <div v-if="deployment.exit_code !== null && deployment.exit_code !== undefined">
                            <span class="font-bold text-gray-800">–ö–æ–¥ –≤—ã—Ö–æ–¥–∞:</span> {{ deployment.exit_code }}
                        </div>
                        <div v-if="shortCommitSha">
                            <span class="font-bold text-gray-800">–ö–æ–º–º–∏—Ç:</span> {{ shortCommitSha }}
                        </div>
                        <div v-if="deployment.branch">
                            <span class="font-bold text-gray-800">–í–µ—Ç–∫–∞:</span> {{ deployment.branch }}
                        </div>
                    </div>
                    <div v-if="truncatedMessage" class="my-2 italic text-gray-600">
                        {{ truncatedMessage }}
                    </div>
                    <div v-if="isActive || deployment.status === 'queued'">
                        <div v-if="deployment.status === 'queued'" class="bg-gray-100 text-gray-600 p-4 rounded mt-2 text-sm text-center">
                            –û–∂–∏–¥–∞–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥–∏...
                        </div>
                        <div v-else class="bg-gray-900 text-gray-300 p-4 rounded mt-2 font-mono text-xs max-h-96 overflow-y-auto logs-container">
                            <div v-if="logs.length === 0" class="my-1 whitespace-pre-wrap break-words">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
                            <div 
                                v-for="(log, index) in logs" 
                                :key="index"
                                :class="['my-1 whitespace-pre-wrap break-words', log.type === 'stderr' ? 'text-red-400' : 'text-gray-300']"
                            >
                                {{ log.line }}
                            </div>
                        </div>
                    </div>
                    <button 
                        v-if="!isActive && deployment.status !== 'queued'"
                        @click="$emit('show-logs', deployment.id)"
                        class="mt-2 text-sm text-primary-light hover:text-blue-700 font-medium cursor-pointer"
                    >
                        –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ ‚Üí
                    </button>
                </div>
            `
        };

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–ø–ª–æ–µ–≤ (–∫–æ–º–ø–∞–∫—Ç–Ω—ã–π)
        const DeploymentHistoryItem = {
            props: {
                deployment: { type: Object, required: true },
                services: { type: Array, required: true },
                isActive: { type: Boolean, default: false }
            },
            data() {
                return {
                    logs: [],
                    eventSource: null
                };
            },
            data() {
                return {
                    logs: [],
                    showLogs: false
                };
            },
            computed: {
                serviceName() {
                    const service = this.services.find(s => s.id === this.deployment.service_id);
                    return service ? service.name : 'Unknown';
                },
                statusText() {
                    const statusMap = {
                        'queued': '–í –æ—á–µ—Ä–µ–¥–∏',
                        'running': '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è',
                        'success': '–£—Å–ø–µ—à–Ω–æ',
                        'failed': '–û—à–∏–±–∫–∞'
                    };
                    return statusMap[this.deployment.status] || this.deployment.status;
                },
                statusBadgeClass() {
                    const classes = {
                        'queued': 'bg-yellow-500 text-white',
                        'running': 'bg-primary-light text-white',
                        'success': 'bg-success text-white',
                        'failed': 'bg-danger text-white'
                    };
                    return classes[this.deployment.status] || 'bg-gray-500 text-white';
                },
                borderClass() {
                    const classes = {
                        'queued': 'border-l-2 border-yellow-500',
                        'running': 'border-l-2 border-primary-light',
                        'success': 'border-l-2 border-success',
                        'failed': 'border-l-2 border-danger'
                    };
                    return classes[this.deployment.status] || 'border-l-2 border-gray-400';
                },
                formattedStartTime() {
                    if (!this.deployment.started_at) return '';
                    const date = new Date(this.deployment.started_at);
                    return date.toLocaleString('ru-RU', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                },
                formattedEndTime() {
                    if (!this.deployment.finished_at) return '';
                    const date = new Date(this.deployment.finished_at);
                    return date.toLocaleString('ru-RU', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                },
                shortCommitSha() {
                    if (!this.deployment.commit_sha) return '';
                    return this.deployment.commit_sha.substring(0, 7);
                },
                duration() {
                    if (!this.deployment.started_at) return '';
                    const start = new Date(this.deployment.started_at);
                    const end = this.deployment.finished_at ? new Date(this.deployment.finished_at) : new Date();
                    const diff = Math.floor((end - start) / 1000);
                    if (diff < 60) return `${diff}—Å`;
                    const minutes = Math.floor(diff / 60);
                    const seconds = diff % 60;
                    return `${minutes}–º ${seconds}—Å`;
                }
            },
            mounted() {
                if (this.isActive && (this.deployment.status === 'running' || this.deployment.status === 'queued')) {
                    this.connectToLogs();
                } else if (this.deployment.stdout || this.deployment.stderr) {
                    if (this.deployment.stdout) {
                        this.deployment.stdout.split('\n').forEach(line => {
                            if (line.trim()) {
                                this.logs.push({ type: 'stdout', line: line });
                            }
                        });
                    }
                    if (this.deployment.stderr) {
                        this.deployment.stderr.split('\n').forEach(line => {
                            if (line.trim()) {
                                this.logs.push({ type: 'stderr', line: line });
                            }
                        });
                    }
                }
            },
            beforeUnmount() {
                if (this.eventSource) {
                    this.eventSource.close();
                }
            },
            methods: {
                connectToLogs() {
                    if (!this.isActive || (this.deployment.status !== 'running' && this.deployment.status !== 'queued')) {
                        return;
                    }
                    
                    this.eventSource = new EventSource(`/api/deployments/${this.deployment.id}/logs`);
                    
                    this.eventSource.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'status') {
                            this.$emit('update-status', {
                                id: this.deployment.id,
                                status: data.status,
                                exit_code: data.exit_code
                            });
                            this.eventSource.close();
                            return;
                        }
                        
                        this.logs.push({
                            type: data.type,
                            line: data.line
                        });
                    };
                    
                    this.eventSource.onerror = (error) => {
                        console.error('–û—à–∏–±–∫–∞ SSE:', error);
                        this.eventSource.close();
                    };
                }
            },
            template: `
                <div :class="['border rounded p-2 bg-white hover:bg-gray-50 transition-colors', borderClass, isActive && (deployment.status === 'running' || deployment.status === 'queued') ? 'border-yellow-400 border-2' : 'border-gray-200']">
                    <div class="flex items-center justify-between gap-2">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <span class="font-semibold text-sm text-gray-800 truncate">{{ serviceName }}</span>
                            <span :class="['px-2 py-0.5 rounded text-xs font-bold uppercase whitespace-nowrap', statusBadgeClass]">
                                {{ statusText }}
                            </span>
                            <span class="text-xs text-gray-500 whitespace-nowrap">{{ formattedStartTime }}</span>
                            <span v-if="formattedEndTime" class="text-xs text-gray-500 whitespace-nowrap">‚Üí {{ formattedEndTime }}</span>
                            <span v-if="duration" class="text-xs text-gray-400 whitespace-nowrap">({{ duration }})</span>
                            <span v-if="shortCommitSha" class="text-xs text-gray-400 font-mono whitespace-nowrap">{{ shortCommitSha }}</span>
                            <span v-if="deployment.branch" class="text-xs text-gray-400 whitespace-nowrap">{{ deployment.branch }}</span>
                            <span v-if="deployment.exit_code !== null && deployment.exit_code !== undefined" 
                                  :class="['text-xs whitespace-nowrap', deployment.exit_code === 0 ? 'text-gray-500' : 'text-red-600']">
                                –∫–æ–¥: {{ deployment.exit_code }}
                            </span>
                        </div>
                        <button 
                            v-if="isActive || logs.length > 0 || deployment.stdout || deployment.stderr"
                            @click="$emit('show-logs', deployment.id)"
                            class="ml-auto text-xs text-primary-light hover:text-blue-700 font-medium cursor-pointer"
                        >
                            –õ–æ–≥–∏ ‚Üí
                        </button>
                    </div>
                </div>
            `
        };

        // –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        createApp({
            components: {
                DeploymentCard,
                DeploymentHistoryItem
            },
            data() {
                return {
                    activeDeployments: [],
                    recentDeployments: [],
                    services: [],
                    loading: {
                        deployments: false
                    },
                    refreshInterval: null,
                    deployingServices: [],
                    logsDrawerOpen: false,
                    logsDrawerDeployment: null,
                    logsDrawerLogs: [],
                    logsDrawerEventSource: null,
                    escHandler: null
                };
            },
            computed: {
                allDeployments() {
                    const all = [...this.activeDeployments, ...this.recentDeployments];
                    console.log('Computed allDeployments:', all.length, 'active:', this.activeDeployments.length, 'recent:', this.recentDeployments.length);
                    return all;
                }
            },
            mounted() {
                this.loadInitialData();
                // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–ø–ª–æ–µ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏)
                this.refreshInterval = setInterval(() => {
                    this.refreshActiveDeploymentsSilent();
                }, 5000);
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ ESC –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è drawer
                this.escHandler = (event) => {
                    if (event.key === 'Escape' && this.logsDrawerOpen) {
                        this.closeLogsDrawer();
                    }
                };
                document.addEventListener('keydown', this.escHandler);
            },
            beforeUnmount() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
                if (this.escHandler) {
                    document.removeEventListener('keydown', this.escHandler);
                }
            },
            methods: {
                async loadInitialData() {
                    await Promise.all([
                        this.loadDeployments(),
                        this.loadServices()
                    ]);
                },
                async loadDeployments() {
                    this.loading.deployments = true;
                    try {
                        const [activeResponse, recentResponse] = await Promise.all([
                            fetch('/api/deployments/active'),
                            fetch('/api/deployments?limit=50')
                        ]);
                        const activeData = await activeResponse.json();
                        const recentData = await recentResponse.json();
                        
                        console.log('Active deployments from API:', activeData);
                        console.log('Recent deployments from API:', recentData);
                        
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Vue.set –∏–ª–∏ –ø—Ä—è–º–æ–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                        const activeList = activeData.active_deployments || [];
                        const recentList = recentData.deployments || [];
                        
                        // –ò—Å–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–µ–ø–ª–æ–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
                        const activeIds = new Set(activeList.map(d => d.id));
                        const filteredRecent = recentList
                            .filter(d => d.status !== 'running' && d.status !== 'queued' && !activeIds.has(d.id))
                            .slice(0, 20);
                        
                        // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤—ã –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                        this.activeDeployments.splice(0, this.activeDeployments.length, ...activeList);
                        this.recentDeployments.splice(0, this.recentDeployments.length, ...filteredRecent);
                        
                        console.log('Active deployments after processing:', this.activeDeployments.length);
                        console.log('Recent deployments after processing:', this.recentDeployments.length);
                        console.log('All deployments count:', this.allDeployments.length);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ–ø–ª–æ–µ–≤:', error);
                    } finally {
                        this.loading.deployments = false;
                    }
                },
                async loadActiveDeployments() {
                    try {
                        const response = await fetch('/api/deployments/active');
                        const data = await response.json();
                        this.activeDeployments = data.active_deployments || [];
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–ø–ª–æ–µ–≤:', error);
                    }
                },
                async refreshActiveDeploymentsSilent() {
                    // –¢–∏—Ö–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –ø–æ–∫–∞–∑–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
                    try {
                        const response = await fetch('/api/deployments/active');
                        const data = await response.json();
                        const newDeployments = data.active_deployments || [];
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–µ–ø–ª–æ–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
                        const existingIds = new Set(this.activeDeployments.map(d => d.id));
                        const newIds = new Set(newDeployments.map(d => d.id));
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–µ–ø–ª–æ–∏ –ø–æ –æ–¥–Ω–æ–º—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                        const toRemove = [];
                        this.activeDeployments.forEach((existingDeployment, index) => {
                            const newDeployment = newDeployments.find(nd => nd.id === existingDeployment.id);
                            if (newDeployment) {
                                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –ø–æ–ª—è (Vue 3 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è)
                                Object.assign(existingDeployment, newDeployment);
                            } else if (!newIds.has(existingDeployment.id)) {
                                // –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω, –ø–æ–º–µ—á–∞–µ–º –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                                if (existingDeployment.status === 'success' || existingDeployment.status === 'failed') {
                                    toRemove.push(index);
                                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –µ—â—ë –Ω–µ—Ç
                                    if (!this.recentDeployments.find(rd => rd.id === existingDeployment.id)) {
                                        this.recentDeployments.unshift({ ...existingDeployment });
                                        if (this.recentDeployments.length > 20) {
                                            this.recentDeployments.pop();
                                        }
                                    }
                                }
                            }
                        });
                        
                        // –£–¥–∞–ª—è–µ–º –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –¥–µ–ø–ª–æ–∏ (–≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ, —á—Ç–æ–±—ã –∏–Ω–¥–µ–∫—Å—ã –Ω–µ —Å–±–∏–ª–∏—Å—å)
                        toRemove.reverse().forEach(index => {
                            this.activeDeployments.splice(index, 1);
                        });
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–µ–ø–ª–æ–∏
                        newDeployments.forEach(newDeployment => {
                            if (!existingIds.has(newDeployment.id)) {
                                this.activeDeployments.push(newDeployment);
                            }
                        });
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–ø–ª–æ–µ–≤:', error);
                    }
                },
                async loadRecentDeployments() {
                    this.loading.recent = true;
                    try {
                        const response = await fetch('/api/deployments?limit=20');
                        const data = await response.json();
                        const newDeployments = (data.deployments || [])
                            .filter(d => d.status !== 'running' && d.status !== 'queued')
                            .slice(0, 20);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª—Å—è
                        const currentIds = new Set(this.recentDeployments.map(d => d.id));
                        const newIds = new Set(newDeployments.map(d => d.id));
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ –¥–µ–ø–ª–æ–∏
                        const hasNew = newDeployments.some(d => !currentIds.has(d.id));
                        const hasRemoved = this.recentDeployments.some(d => !newIds.has(d.id));
                        
                        if (hasNew || hasRemoved) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–æ–≤—ã–µ –∏–ª–∏ —É–¥–∞–ª—ë–Ω–Ω—ã–µ)
                            this.recentDeployments = newDeployments;
                        }
                        // –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–æ–æ–±—â–µ - —ç—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—ë—Ä–≥–∞–Ω–∏—è
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–ø–ª–æ–µ–≤:', error);
                    } finally {
                        this.loading.recent = false;
                    }
                },
                async loadServices() {
                    try {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã –∏–∑ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —á–µ—Ä–µ–∑ API
                        {% endraw %}
                        const servicesData = {{ services_json | safe }};
                        {% raw %}
                        this.services = servicesData || [];
                        
                        // –¢–∞–∫–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–µ–∑ API –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        const response = await fetch('/api/services');
                        const data = await response.json();
                        if (data.services && data.services.length > 0) {
                            this.services = data.services;
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤:', error);
                    }
                },
                async refreshDeployments() {
                    await this.loadDeployments();
                },
                async refreshActiveDeployments() {
                    await this.loadActiveDeployments();
                },
                async refreshRecentDeployments() {
                    try {
                        const response = await fetch('/api/deployments?limit=50');
                        const data = await response.json();
                        // –ò—Å–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–µ–ø–ª–æ–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
                        const activeIds = new Set(this.activeDeployments.map(d => d.id));
                        this.recentDeployments = (data.deployments || [])
                            .filter(d => d.status !== 'running' && d.status !== 'queued' && !activeIds.has(d.id))
                            .slice(0, 20);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–ø–ª–æ–µ–≤:', error);
                    }
                },
                updateDeploymentStatus(payload) {
                    const deployment = this.activeDeployments.find(d => d.id === payload.id);
                    if (deployment) {
                        deployment.status = payload.status;
                        deployment.exit_code = payload.exit_code;
                        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è (—Ç–∏—Ö–æ, –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)
                        setTimeout(() => {
                            this.refreshActiveDeploymentsSilent();
                            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω
                            if (payload.status === 'success' || payload.status === 'failed') {
                                this.refreshRecentDeployments();
                            }
                        }, 2000);
                    }
                },
                async deployService(serviceId) {
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–∏—Å –≤ —Å–ø–∏—Å–æ–∫ –∑–∞–ø—É—Å–∫–∞—é—â–∏—Ö—Å—è
                    if (this.deployingServices.includes(serviceId)) {
                        return;
                    }
                    this.deployingServices.push(serviceId);
                    
                    try {
                        const response = await fetch(`/api/services/${serviceId}/deploy`, {
                            method: 'POST'
                        });
                        
                        if (!response.ok) {
                            const error = await response.json();
                            alert(`–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –¥–µ–ø–ª–æ—è: ${error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                            return;
                        }
                        
                        const data = await response.json();
                        console.log('–î–µ–ø–ª–æ–π –∑–∞–ø—É—â–µ–Ω:', data);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–ø–ª–æ–µ–≤
                        await this.refreshActiveDeployments();
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –¥–µ–ø–ª–æ—è:', error);
                        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –¥–µ–ø–ª–æ—è: ' + error.message);
                    } finally {
                        // –£–¥–∞–ª—è–µ–º —Å–µ—Ä–≤–∏—Å –∏–∑ —Å–ø–∏—Å–∫–∞ –∑–∞–ø—É—Å–∫–∞—é—â–∏—Ö—Å—è
                        const index = this.deployingServices.indexOf(serviceId);
                        if (index > -1) {
                            this.deployingServices.splice(index, 1);
                        }
                    }
                },
                async showLogsDrawer(deploymentId) {
                    // –ù–∞—Ö–æ–¥–∏–º –¥–µ–ø–ª–æ–π
                    let deployment = this.activeDeployments.find(d => d.id === deploymentId);
                    if (!deployment) {
                        deployment = this.recentDeployments.find(d => d.id === deploymentId);
                    }
                    
                    if (!deployment) {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ API
                        try {
                            const response = await fetch(`/api/deployments/${deploymentId}`);
                            const data = await response.json();
                            deployment = data;
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ–ø–ª–æ—è:', error);
                            return;
                        }
                    }
                    
                    this.logsDrawerDeployment = deployment;
                    this.logsDrawerLogs = [];
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–∏
                    if (deployment.status === 'running' || deployment.status === 'queued') {
                        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ SSE –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–ø–ª–æ–µ–≤
                        this.logsDrawerEventSource = new EventSource(`/api/deployments/${deploymentId}/logs`);
                        
                        this.logsDrawerEventSource.onmessage = (event) => {
                            const data = JSON.parse(event.data);
                            
                            if (data.type === 'status') {
                                this.logsDrawerEventSource.close();
                                this.logsDrawerEventSource = null;
                                return;
                            }
                            
                            this.logsDrawerLogs.push({
                                type: data.type,
                                line: data.line
                            });
                            
                            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞
                            this.$nextTick(() => {
                                const drawer = document.querySelector('.logs-drawer-content');
                                if (drawer) {
                                    drawer.scrollTop = drawer.scrollHeight;
                                }
                            });
                        };
                        
                        this.logsDrawerEventSource.onerror = (error) => {
                            console.error('–û—à–∏–±–∫–∞ SSE:', error);
                            this.logsDrawerEventSource.close();
                            this.logsDrawerEventSource = null;
                        };
                    } else {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –¥–µ–ø–ª–æ—è
                        if (deployment.stdout) {
                            deployment.stdout.split('\n').forEach(line => {
                                if (line.trim()) {
                                    this.logsDrawerLogs.push({ type: 'stdout', line: line });
                                }
                            });
                        }
                        if (deployment.stderr) {
                            deployment.stderr.split('\n').forEach(line => {
                                if (line.trim()) {
                                    this.logsDrawerLogs.push({ type: 'stderr', line: line });
                                }
                            });
                        }
                    }
                    
                    this.logsDrawerOpen = true;
                },
                closeLogsDrawer() {
                    if (this.logsDrawerEventSource) {
                        this.logsDrawerEventSource.close();
                        this.logsDrawerEventSource = null;
                    }
                    this.logsDrawerOpen = false;
                    this.logsDrawerDeployment = null;
                    this.logsDrawerLogs = [];
                },
                getServiceName(deployment) {
                    if (!deployment) return '';
                    if (deployment.service_name) return deployment.service_name;
                    const service = this.services.find(s => s.id === deployment.service_id);
                    return service ? service.name : 'Unknown';
                }
            }
        }).mount('#app');
    </script>
    {% endraw %}
</body>
</html>
